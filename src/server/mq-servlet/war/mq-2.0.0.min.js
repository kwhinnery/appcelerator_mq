/*
 * XMLHttpRequest.js Copyright (C) 2008 Sergey Ilinsky (http://www.ilinsky.com)
 *
 * This work is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation; either version 2.1 of the License, or
 * (at your option) any later version.
 *
 * This work is distributed in the hope that it will be useful,
 * but without any warranty; without even the implied warranty of
 * merchantability or fitness for a particular purpose. See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
 **/
(function(){var D=window.XMLHttpRequest;var H=!!window.controllers,E=window.document.all&&!window.opera;function C(){this._object=D?new D:new window.ActiveXObject("Microsoft.XMLHTTP");this._listeners=[]}if(H&&D.wrapped){C.wrapped=D.wrapped}C.UNSENT=0;C.OPENED=1;C.HEADERS_RECEIVED=2;C.LOADING=3;C.DONE=4;C.prototype.readyState=C.UNSENT;C.prototype.responseText="";C.prototype.responseXML=null;C.prototype.status=0;C.prototype.statusText="";C.prototype.onreadystatechange=null;C.onreadystatechange=null;C.onopen=null;C.onsend=null;C.onabort=null;C.prototype.open=function(L,O,K,P,J){if(arguments.length<3){K=true}this._async=K;var N=this,M=this.readyState;if(E){var I=function(){if(N._object.readyState!=C.DONE){A(N);N.abort()}};if(K){window.attachEvent("onunload",I)}}this._object.onreadystatechange=function(){if(H&&!K){return }N.readyState=N._object.readyState;G(N);if(N._aborted){N.readyState=C.UNSENT;return }if(N.readyState==C.DONE){A(N);if(E&&K){window.detachEvent("onunload",I)}}if(M!=N.readyState){F(N)}M=N.readyState};if(C.onopen){C.onopen.apply(this,arguments)}if(arguments.length>4){this._object.open(L,O,K,P,J)}else{if(arguments.length>3){this._object.open(L,O,K,P)}else{this._object.open(L,O,K)}}if(!K&&H){this.readyState=C.OPENED;F(this)}};C.prototype.send=function(I){if(C.onsend){C.onsend.apply(this,arguments)}if(I&&I.nodeType){I=window.XMLSerializer?new window.XMLSerializer().serializeToString(I):I.xml;if(!this._headers["Content-Type"]){this._object.setRequestHeader("Content-Type","application/xml")}}this._object.send(I);if(H&&!this._async){this.readyState=C.OPENED;G(this);while(this.readyState<C.DONE){this.readyState++;F(this);if(this._aborted){return }}}};C.prototype.abort=function(){if(C.onabort){C.onabort.apply(this,arguments)}if(this.readyState>C.UNSENT){this._aborted=true}this._object.abort();A(this)};C.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()};C.prototype.getResponseHeader=function(I){return this._object.getResponseHeader(I)};C.prototype.setRequestHeader=function(I,J){if(!this._headers){this._headers={}}this._headers[I]=J;return this._object.setRequestHeader(I,J)};C.prototype.addEventListener=function(L,K,J){for(var I=0,M;M=this._listeners[I];I++){if(M[0]==L&&M[1]==K&&M[2]==J){return }}this._listeners.push([L,K,J])};C.prototype.removeEventListener=function(L,K,J){for(var I=0,M;M=this._listeners[I];I++){if(M[0]==L&&M[1]==K&&M[2]==J){break}}if(M){this._listeners.splice(I,1)}};C.prototype.dispatchEvent=function(J){var J={type:J.type,target:this,currentTarget:this,eventPhase:2,bubbles:J.bubbles,cancelable:J.cancelable,timeStamp:J.timeStamp,stopPropagation:function(){},preventDefault:function(){},initEvent:function(){}};if(J.type=="readystatechange"&&this.onreadystatechange){(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[J])}for(var I=0,K;K=this._listeners[I];I++){if(K[0]==J.type&&!K[2]){(K[1].handleEvent||K[1]).apply(this,[J])}}};C.prototype.toString=function(){return"[object XMLHttpRequest]"};C.toString=function(){return"[XMLHttpRequest]"};function F(I){if(C.onreadystatechange){C.onreadystatechange.apply(I)}I.dispatchEvent({type:"readystatechange",bubbles:false,cancelable:false,timeStamp:new Date+0})}function B(J){var I=J.responseXML;if(E&&I&&!I.documentElement&&J.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/)){I=new window.ActiveXObject("Microsoft.XMLDOM");I.loadXML(J.responseText)}if(I){if((E&&I.parseError!=0)||(I.documentElement&&I.documentElement.tagName=="parsererror")){return null}}return I}function G(I){try{I.responseText=I._object.responseText}catch(J){}try{I.responseXML=B(I._object)}catch(J){}try{I.status=I._object.status}catch(J){}try{I.statusText=I._object.statusText}catch(J){}}function A(I){I._object.onreadystatechange=new window.Function;delete I._headers}if(!window.Function.prototype.apply){window.Function.prototype.apply=function(I,J){if(!J){J=[]}I.__func=this;I.__func(J[0],J[1],J[2],J[3],J[4]);delete I.__func}}window.XMLHttpRequest=C})();
/*
 * Copyright 2009 Appcelerator, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * 
 * Appcelerator Message Queue (Appcelerator MQ)
 * --------------------------------------------
 * Author: 
 * Appcelerator Inc.
 *
 * Description: 
 * Lightweight client-side or client-server message queue
 *
 **/
(function(){window.mq={};mq.extend=function(){var F=arguments[0]||{},E=1,D=arguments.length,H=false,I,C,A,B;if(typeof F==="boolean"){H=F;F=arguments[1]||{};E=2}if(typeof F!=="object"&&!mq.isFunction(F)){F={}}if(D===E){F=this;--E}for(;E<D;E++){if((I=arguments[E])!=null){for(C in I){A=F[C];B=I[C];if(F===B){continue}if(H&&B&&typeof B==="object"&&!B.nodeType){var G;if(A){G=A}else{if(mq.isArray(B)){G=[]}else{if(mq.isObject(B)){G={}}else{G=B}}}F[C]=mq.extend(H,G,B)}else{if(B!==undefined){F[C]=B}}}}}return F};mq.extend({isFunction:function(A){return toString.call(A)==="[object Function]"},isArray:function(A){return toString.call(A)==="[object Array]"},isObject:function(A){return this.constructor.call(A)===Object}})})();(function(){if(!mq.JSON){mq.JSON={}}function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"&&typeof (window.Prototype)==="undefined"&&typeof (window.MooTools)==="undefined"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof mq.JSON.stringify!=="function"){mq.JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("mq.JSON.stringify")}return str("",{"":value})}}if(typeof mq.JSON.parse!=="function"){mq.JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("mq.JSON.parse")}}})();(function(){var A=[];var B=[];function D(){while(A.length>0){var E=A.shift();for(listener_index in B){var F=B[listener_index];if(C(E,F)){if(F.callback.call(this,E)==true){break}}}}setTimeout(D,mq.config.scan_interval)}function C(F,G){var E=false;if(F.scope===G.scope){if((G.pattern.test&&G.pattern.test(F.name))||(G.pattern===F.name)){E=true}}return E}mq.extend(true,{config:{scan_interval:150},pub:function(H,F,E){var G=null;if(typeof H=="string"){G=mq.extend({name:H,payload:(F)?F:{},scope:"default"},E||{})}else{G=mq.extend({name:"message",payload:{},scope:"default"},H)}A.push(G)},sub:function(G,E,F){var H=mq.extend({pattern:G,callback:E,scope:"default",priority:-1,handle:"listener"+Math.random().toString()},F||{});B.push(H);B.sort(function(J,I){return I.priority-J.priority});return H},unsub:function(F){for(listener_index in B){var E=B[listener_index];if(F.handle===E.handle){B.splice(listener_index,1)}}}});D()})();(function(){mq.extend(mq.config,{endpoint:"/mq"});mq.sub(/r:.*\.request/,function(B){var A=new XMLHttpRequest();A.open("POST",mq.config.endpoint);A.setRequestHeader("Content-Type","application/json");A.onreadystatechange=function(){if(this.readyState==XMLHttpRequest.DONE){if(this.status==200){var C=mq.JSON.parse(this.responseText);mq.pub(C)}}};A.send(mq.JSON.stringify(B))})})();